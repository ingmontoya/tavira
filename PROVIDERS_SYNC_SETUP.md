# Pasos para Implementar el Sistema de Sincronizaci√≥n de Proveedores

## ‚úÖ Archivos Creados

### Modelos
- ‚úÖ `app/Models/Central/Provider.php` - Modelo central con SyncMaster
- ‚úÖ `app/Models/Provider.php` - Modelo tenant con Syncable

### Migraciones
- ‚úÖ `database/migrations/landlord/2025_10_16_000001_create_providers_table.php` - Migraci√≥n central
- ‚úÖ `database/migrations/tenant/2025_10_16_000001_create_providers_table.php` - Migraci√≥n tenant

### Listeners
- ‚úÖ `app/Listeners/SyncProvidersToNewTenant.php` - Sincroniza proveedores al crear tenant

### Comandos
- ‚úÖ `app/Console/Commands/SyncProviders.php` - Comando de sincronizaci√≥n manual

### Configuraci√≥n
- ‚úÖ `config/database.php` - Conexi√≥n 'central' agregada
- ‚úÖ `app/Providers/AppServiceProvider.php` - Eventos registrados

### Documentaci√≥n
- ‚úÖ `PROVIDERS_SYNC_GUIDE.md` - Gu√≠a completa del sistema
- ‚úÖ `PROVIDERS_SYNC_EXAMPLES.md` - Ejemplos pr√°cticos de c√≥digo
- ‚úÖ `PROVIDERS_SYNC_SETUP.md` - Este archivo

---

## üìã Pasos de Implementaci√≥n

### Paso 1: Configurar Base de Datos Central

```bash
# 1. Aseg√∫rate de que tu .env tenga la configuraci√≥n correcta
DB_CONNECTION=central
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=tavira_central
DB_USERNAME=root
DB_PASSWORD=tu_password
```

### Paso 2: Crear Base de Datos Central (si no existe)

```bash
# MySQL/MariaDB
mysql -u root -p
CREATE DATABASE tavira_central CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;
```

### Paso 3: Ejecutar Migraciones

```bash
# 1. Ejecutar migraciones centrales
php artisan migrate --path=database/migrations/landlord --database=central

# 2. Ejecutar migraciones en todos los tenants
php artisan tenants:migrate
```

**Salida esperada:**
```
Migrating: 2025_10_16_000001_create_providers_table
Migrated:  2025_10_16_000001_create_providers_table (X.XX seconds)
```

### Paso 4: Verificar Tablas Creadas

```bash
php artisan tinker

# Verificar tabla central
>>> DB::connection('central')->table('providers')->count()
=> 0

# Verificar tabla en un tenant
>>> tenancy()->initialize('tu-tenant-id');
>>> DB::table('providers')->count()
=> 0
```

### Paso 5: Limpiar Cach√©s

```bash
php artisan config:clear
php artisan cache:clear
php artisan event:clear
php artisan optimize
```

### Paso 6: Crear Proveedores de Prueba

```bash
php artisan tinker
```

```php
// En tinker
use App\Models\Central\Provider;

// Crear proveedor central
$provider = Provider::create([
    'name' => 'Proveedor de Prueba',
    'category' => 'Testing',
    'phone' => '3001234567',
    'email' => 'test@provider.com',
    'document_type' => 'NIT',
    'document_number' => '900123456-7',
    'is_active' => true,
]);

// Verificar que se cre√≥
Provider::count();
// => 1
```

### Paso 7: Verificar Sincronizaci√≥n Autom√°tica

```bash
php artisan tinker
```

```php
// En tinker, verificar en un tenant
tenancy()->initialize('tu-tenant-id');
\App\Models\Provider::count();
// Deber√≠a ser >= 1 si la sincronizaci√≥n funcion√≥
```

### Paso 8: Probar Sincronizaci√≥n Manual

```bash
# Sincronizar manualmente a todos los tenants
php artisan sync:providers

# Salida esperada:
# Starting provider synchronization...
# Found 1 providers in central database.
# Syncing to X tenant(s)...
# [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%
#
# Synchronization completed!
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ Metric                      ‚îÇ Count ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ Central Providers           ‚îÇ 1     ‚îÇ
# ‚îÇ Tenants Processed           ‚îÇ X     ‚îÇ
# ‚îÇ Records Synced/Updated      ‚îÇ X     ‚îÇ
# ‚îÇ Records Skipped (no changes)‚îÇ 0     ‚îÇ
# ‚îÇ Errors                      ‚îÇ 0     ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Paso 9: Configurar Colas (Recomendado para Producci√≥n)

```bash
# 1. Configurar Redis en .env
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# 2. Iniciar worker de colas
php artisan queue:work

# 3. Para desarrollo, puedes usar sync
QUEUE_CONNECTION=sync
```

### Paso 10: Auditar Sincronizaci√≥n

```bash
# Verificar estado de sincronizaci√≥n
php artisan sync:audit-providers

# Salida esperada:
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ Tenant          ‚îÇ Synced ‚îÇ Local ‚îÇ Total ‚îÇ Status ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ tenant1         ‚îÇ 1      ‚îÇ 0     ‚îÇ 1     ‚îÇ ‚úì      ‚îÇ
# ‚îÇ tenant2         ‚îÇ 1      ‚îÇ 2     ‚îÇ 3     ‚îÇ ‚úì      ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ Tests de Validaci√≥n

### Test 1: Crear Proveedor Central

```bash
php artisan tinker
```

```php
use App\Models\Central\Provider;

$provider = Provider::create([
    'name' => 'Test Provider ' . now()->timestamp,
    'email' => 'test' . now()->timestamp . '@example.com',
    'is_active' => true,
]);

echo "Proveedor creado con ID: {$provider->id}\n";
```

### Test 2: Verificar en Tenants

```php
use App\Models\Tenant;

$tenants = Tenant::take(3)->get();

foreach ($tenants as $tenant) {
    $tenant->run(function () use ($tenant, $provider) {
        $synced = \App\Models\Provider::where('global_provider_id', $provider->id)->first();
        if ($synced) {
            echo "‚úì Tenant {$tenant->id}: Sincronizado\n";
        } else {
            echo "‚úó Tenant {$tenant->id}: NO sincronizado\n";
        }
    });
}
```

### Test 3: Actualizar Proveedor Central

```php
$provider->update(['name' => 'Updated Name ' . now()->timestamp]);

echo "Proveedor actualizado\n";

// Esperar un momento si usas colas
sleep(2);

// Verificar actualizaci√≥n en tenant
$tenant = Tenant::first();
$tenant->run(function () use ($provider) {
    $synced = \App\Models\Provider::where('global_provider_id', $provider->id)->first();
    echo "Nombre en tenant: {$synced->name}\n";
});
```

### Test 4: Crear Proveedor Local en Tenant

```php
$tenant = Tenant::first();
$tenant->run(function () {
    $local = \App\Models\Provider::create([
        'name' => 'Local Provider',
        'email' => 'local@example.com',
        'is_active' => true,
        // No tiene global_provider_id
    ]);

    echo "Proveedor local creado\n";
    echo "Es sincronizado: " . ($local->isSynced() ? 'S√≠' : 'No') . "\n";
});
```

---

## üîß Troubleshooting

### Error: Class "App\Models\Central\Provider" not found

**Soluci√≥n:**
```bash
composer dump-autoload
php artisan optimize:clear
```

### Error: SQLSTATE[42S02]: Base table or view not found

**Soluci√≥n:**
```bash
# Verificar que las migraciones se ejecutaron
php artisan migrate:status --database=central
php artisan tenants:migrate --pretend
```

### Error: Connection [central] not configured

**Soluci√≥n:**
```bash
# Verificar config/database.php
php artisan config:clear
php artisan config:cache
```

### Proveedores no se sincronizan autom√°ticamente

**Soluci√≥n:**
```bash
# 1. Verificar eventos registrados
php artisan event:list | grep Synced

# 2. Verificar logs
tail -f storage/logs/laravel.log

# 3. Sincronizar manualmente
php artisan sync:providers

# 4. Verificar que los listeners existan
ls -la app/Listeners/SyncProviders*
```

### Performance lento con muchos tenants

**Soluci√≥n:**
```bash
# 1. Usar colas
QUEUE_CONNECTION=redis

# 2. Iniciar m√∫ltiples workers
php artisan queue:work --queue=high,default --tries=3 &
php artisan queue:work --queue=high,default --tries=3 &
php artisan queue:work --queue=high,default --tries=3 &

# 3. Supervisar con Laravel Horizon (opcional)
composer require laravel/horizon
php artisan horizon:install
php artisan horizon
```

---

## üìä Monitoreo

### Logs a Revisar

```bash
# Ver logs en tiempo real
php artisan pail

# Filtrar logs de sincronizaci√≥n
tail -f storage/logs/laravel.log | grep -i "sync"
```

### M√©tricas Importantes

1. **Tiempo de sincronizaci√≥n**: Tiempo que toma sincronizar un proveedor a todos los tenants
2. **Tasa de errores**: Porcentaje de fallos en sincronizaci√≥n
3. **Cola de jobs**: Cantidad de jobs pendientes en cola
4. **Diferencias de datos**: Proveedores que est√°n desactualizados en tenants

---

## üöÄ Optimizaciones Avanzadas

### 1. Sincronizaci√≥n Selectiva

```php
// Solo sincronizar a tenants activos
Event::listen(SyncedResourceSaved::class, function ($event) {
    $activeTenants = Tenant::where('subscription_status', 'active')->get();
    // Sincronizar solo a tenants activos
});
```

### 2. Batch Processing

```php
use Illuminate\Support\Facades\Bus;

$jobs = collect($tenants)->map(function ($tenant) use ($provider) {
    return new SyncProviderToTenant($provider->id, $tenant->id);
});

Bus::batch($jobs)->dispatch();
```

### 3. Cache de Proveedores

```php
// En modelo Provider tenant
public static function getCachedProviders()
{
    return Cache::remember('providers_list', 3600, function () {
        return self::active()->orderBy('name')->get();
    });
}
```

---

## ‚úÖ Checklist Final

- [ ] Base de datos central creada
- [ ] Conexi√≥n 'central' configurada en database.php
- [ ] Migraciones ejecutadas (central y tenants)
- [ ] Eventos registrados en AppServiceProvider
- [ ] Listener SyncProvidersToNewTenant creado
- [ ] Comando sync:providers funcional
- [ ] Proveedor de prueba creado y sincronizado
- [ ] Colas configuradas (si aplica)
- [ ] Tests de validaci√≥n pasados
- [ ] Logs verificados sin errores
- [ ] Documentaci√≥n revisada

---

## üìö Pr√≥ximos Pasos

1. **Migrar datos existentes**: Si tienes la tabla `suppliers`, crea un script de migraci√≥n
2. **Crear seeders**: Agrega proveedores comunes para todos los tenants
3. **Implementar UI**: Crea interfaces en Vue para gestionar proveedores
4. **Agregar permisos**: Implementa policies para controlar acceso
5. **Configurar auditor√≠a**: Registra cambios en proveedores con audit log

---

## üÜò Soporte

Si encuentras problemas:

1. Revisa los logs: `storage/logs/laravel.log`
2. Ejecuta `php artisan sync:audit-providers` para ver el estado
3. Consulta la documentaci√≥n de Stancl Tenancy: https://tenancyforlaravel.com/docs/v3/synced-resources
4. Revisa los ejemplos en `PROVIDERS_SYNC_EXAMPLES.md`

---

**¬°Sistema de Sincronizaci√≥n de Proveedores Implementado Exitosamente! üéâ**
