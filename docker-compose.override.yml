# =============================================================================
# Docker Compose Override for Local Development with Hot Reload
# =============================================================================
# This file is automatically loaded by docker-compose and overrides/extends
# the base docker-compose.yml configuration for local development.
#
# Usage:
#   docker-compose up -d    # Automatically uses this override
#
# Benefits:
#   - Hot reload: Edit code, refresh browser, see changes immediately
#   - No rebuild needed for PHP/Vue/Blade changes
#   - Only rebuild when dependencies change (composer.json, package.json)
# =============================================================================

version: '3.8'

services:
  # PHP-FPM Application with hot reload
  app:
    build:
      target: orbstack  # Use development stage with dev dependencies
    volumes:
      # Mount entire codebase for hot reload (includes public/build)
      - ./:/var/www/html
      # Exclude vendor and node_modules (use container's versions)
      - /var/www/html/vendor
      - /var/www/html/node_modules
      # Explicitly mount public for built assets (ensures npm run build changes are reflected)
      - ./public:/var/www/html/public
      # Keep storage and cache as before
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    environment:
      # Override opcache settings for development
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      PHP_OPCACHE_REVALIDATE_FREQ: "0"
      PHP_OPCACHE_ENABLE: "1"
      # Vite dev server URL (accessible from host)
      VITE_DEV_SERVER_URL: "http://host.docker.internal:5173"

  # Queue Worker with hot reload
  queue:
    build:
      target: orbstack  # Use development stage with dev dependencies
    volumes:
      # Mount entire codebase for hot reload
      - ./:/var/www/html
      # Exclude vendor and node_modules (use container's versions)
      - /var/www/html/vendor
      - /var/www/html/node_modules
      # Keep storage as before
      - ./storage:/var/www/html/storage
    environment:
      # Override opcache settings for development
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      PHP_OPCACHE_REVALIDATE_FREQ: "0"

  # Nginx with access to code (uses local public directory for hot reload)
  nginx:
    volumes:
      # Use local public directory for hot reload of built assets
      - ./public:/var/www/html/public:ro
      - ./storage:/var/www/html/storage:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  # Optional: Vite dev server for frontend hot module replacement (HMR)
  vite:
    image: node:20-alpine
    container_name: tavira-vite
    working_dir: /app
    command: npm run dev
    ports:
      - "5173:5173"
    volumes:
      - ./:/app
      - /app/node_modules
    environment:
      VITE_HOST: "0.0.0.0"
      VITE_PORT: "5173"
    networks:
      - tavira-network
    profiles:
      - vite  # Optional service, enable with: docker-compose --profile vite up
