apiVersion: v1
kind: ConfigMap
metadata:
  name: tavira-nginx-config-staging
  namespace: staging
  labels:
    app: tavira-staging
    environment: staging
data:
  default.conf: |
    # =============================================================================
    # NGINX Configuration for Laravel/Inertia.js App - STAGING
    # Optimized for Kubernetes sidecar architecture with proper proxy header handling
    # =============================================================================

    # FastCGI Cache Configuration
    # Cache path: 100MB in memory, 500MB on disk, 10min inactive timeout, 60min key validity
    fastcgi_cache_path /var/cache/nginx/fastcgi
                       levels=1:2
                       keys_zone=laravel_cache:100m
                       max_size=500m
                       inactive=10m
                       use_temp_path=off;

    # Cache bypass conditions (don't cache these)
    map $request_method $skip_cache {
        default 0;
        POST 1;
        PUT 1;
        DELETE 1;
        PATCH 1;
    }

    map $http_cookie $skip_cache_cookie {
        default 0;
        ~*laravel_session 1;  # Don't cache if user has session cookie
        ~*XSRF-TOKEN 1;       # Don't cache CSRF protected requests
    }

    # Map proxy headers with fallback to nginx variables
    # This ensures we use Traefik's headers when available
    map $http_x_forwarded_proto $forwarded_proto {
        default $http_x_forwarded_proto;
        "" $scheme;
    }

    map $http_x_forwarded_host $forwarded_host {
        default $http_x_forwarded_host;
        "" $host;
    }

    map $http_x_forwarded_port $forwarded_port {
        default $http_x_forwarded_port;
        "" $server_port;
    }

    map $http_x_forwarded_for $forwarded_for {
        default $http_x_forwarded_for;
        "" $remote_addr;
    }

    # Detect if this is the main domain (landing) vs tenant subdomain
    # Main domains: staging.tavira.com.co, tavira.com.co
    # Tenant domains: *.staging.tavira.com.co, *.tavira.com.co
    map $forwarded_host $is_main_domain {
        default 0;
        "staging.tavira.com.co" 1;
        "tavira.com.co" 1;
        "~^(www\.)?staging\.tavira\.com\.co$" 1;
        "~^(www\.)?tavira\.com\.co$" 1;
    }

    server {
        listen 80;
        listen [::]:80;
        server_name _;

        root /var/www/html/public;
        index index.php index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header X-Environment "staging" always;

        # Disable server tokens
        server_tokens off;

        # Logging (optimized for staging)
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log warn;

        # Client settings
        client_max_body_size 10M;
        client_body_timeout 60s;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript
                   application/json application/javascript application/xml+rss
                   application/rss+xml font/truetype font/opentype
                   application/vnd.ms-fontobject image/svg+xml;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy (staging)\n";
            add_header Content-Type text/plain;
        }

        # Static files - cache for shorter time in staging
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 7d;  # Shorter cache for staging
            add_header Cache-Control "public";
            access_log off;
            try_files $uri =404;
        }

        # Deny access to hidden files
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Main location - serve landing for main domain, Laravel for tenant subdomains
        location / {
            # Set root based on domain
            set $serve_root /var/www/html/public;
            if ($is_main_domain = 1) {
                set $serve_root /var/www/html/public/landing;
            }
            root $serve_root;

            # Try files, fallback to index.html for SPA (landing) or Laravel (tenant)
            try_files $uri $uri/ @fallback;
        }

        # Fallback location
        location @fallback {
            # For main domain, serve index.html (Nuxt SPA)
            if ($is_main_domain = 1) {
                root /var/www/html/public/landing;
                rewrite ^ /index.html break;
            }
            # For tenant domains, route to Laravel
            root /var/www/html/public;
            rewrite ^(.*)$ /index.php?$query_string last;
        }

        # PHP-FPM processing
        location ~ \.php$ {
            # Security: don't execute PHP files from uploads
            location ~ ^/storage/.*\.php$ {
                deny all;
            }

            fastcgi_split_path_info ^(.+\.php)(/.+)$;

            # Connect to PHP-FPM via localhost (same pod in K8s)
            fastcgi_pass 127.0.0.1:9000;

            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;

            include fastcgi_params;

            # Forward proxy headers to PHP
            # Preserve headers from upstream proxy (Traefik) or use nginx variables as fallback
            # This is critical for signed URL validation and multitenancy
            # Override SERVER_NAME to use forwarded host instead of wildcard "_"
            fastcgi_param SERVER_NAME $forwarded_host;
            fastcgi_param HTTP_X_FORWARDED_HOST $forwarded_host;
            fastcgi_param HTTP_X_FORWARDED_PROTO $forwarded_proto;
            fastcgi_param HTTP_X_FORWARDED_FOR $forwarded_for;
            fastcgi_param HTTP_X_FORWARDED_PORT $forwarded_port;

            # Timeouts
            fastcgi_read_timeout 300s;
            fastcgi_send_timeout 300s;

            # Buffer settings
            fastcgi_buffer_size 32k;
            fastcgi_buffers 8 16k;
            fastcgi_busy_buffers_size 32k;

            # Security
            fastcgi_hide_header X-Powered-By;

            # FastCGI Cache Configuration
            fastcgi_cache laravel_cache;
            fastcgi_cache_key "$scheme$request_method$host$request_uri";
            fastcgi_cache_valid 200 10m;       # Cache 200 responses for 10 minutes
            fastcgi_cache_valid 301 302 1h;    # Cache redirects for 1 hour
            fastcgi_cache_valid 404 1m;        # Cache 404s for 1 minute
            fastcgi_cache_use_stale error timeout updating http_500 http_503;
            fastcgi_cache_background_update on;
            fastcgi_cache_lock on;
            fastcgi_cache_lock_timeout 5s;

            # Bypass cache for authenticated users and write operations
            set $final_skip_cache 0;
            if ($skip_cache) {
                set $final_skip_cache 1;
            }
            if ($skip_cache_cookie) {
                set $final_skip_cache 1;
            }
            fastcgi_cache_bypass $final_skip_cache;
            fastcgi_no_cache $final_skip_cache;

            # Add cache status header for debugging
            add_header X-FastCGI-Cache $upstream_cache_status;
        }

        # Deny access to sensitive files
        location ~ /\.(env|git|gitignore|gitattributes) {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
